{% extends 'base.html' %}
{% block title %}{{ article.title }}{% endblock %}
{% block head %}
    <link rel="stylesheet" href="{{ url_for('static',filename='css/detail.css') }}">
{% endblock %}
{% block main %}
    <div class="main">
        <h3 class="page_title">{{ article.title }}</h3>
        <p class="article-info">
            <input type="hidden" value="{{ article.id }}" id="article_id">
            <span>作者：{{ author.username }}</span>
            <span>时间：{{ article.create_time }}</span>
            {% if article.edit_time %}<span>修改时间：{{ article.edit_time }}</span>{% endif %}
            <span>分类：{{ category.name | is_none }}</span>
        </p>
        <p class="article_tags">标签：{% if tags %}{% for tag in tags %}
            <span class="label label-default"><a href="
                                {{ url_for('main.search_article',item = tag,search_type = 'tag') }}">{{ tag }}</a></span>
        {% endfor %}
        {% else %} 未设定{% endif %}
        </p>
        <hr>{% if article.content_html %}
        <p class="article-content">{{ article.content_html | safe }}</p>
    {% else %}<p class="article-content">{{ article.content | safe }}</p>{% endif %}
        <hr>
        {% if user %}
            {% if user.admin %}
                <a href="{{ url_for('admin.edit_blog',article_id = article.id) }}" class="editblog">修改文章</a>
                <a href="{{ url_for('admin.delete_article',article_id = article.id) }}"
                   class="delete_blog">删除文章</a>
            {% endif %}
        {% endif %}
        <h4>评论</h4>
        {% if user %}
            <form action="{{ url_for('main.add_comment') }}" method="post">
                <div class="form-group">
                    <input type="text" class="form-control" name=comment_content placeholder="填写评论">
                    <input type="hidden" name="article_id" value="{{ article.id }}" class="article_id">
                </div>
                <div class="form-group">
                    <button class="btn btn-default">评论</button>
                </div>
            </form>
        {% else %}
            <p><a href="{{ url_for('main.login') }}">登陆</a>后才能评论</p>
        {% endif %}
        {% if comments %}
            <div class="comment-show">
                {% for comment in comments %}
                    {% if loop.first %}
                        <h3>评论数：({{ comments_count }})</h3>
                        <hr>{% endif %}
                    <h4 class="comment">{{ comment.content }}</h4>
                    <div class="comment-info">
                        <input type="hidden" value="{{ comment.author_id }}" class="reply_to">
                        <input type="hidden" value="{{ comment.id }}" class="parent">
                        by <span class="comment-author">{{ comment_author[comment.author_id] }}</span>
                        <span class="comment-time">at {{ comment.create_time }}</span>
                        {% if user %}<a href="javascript:;" class="pl-hf hf-con-block">回复</a>
                            {% if user.admin %}
                                <a href="{{ url_for('admin.delete_comment',comment_id=comment.id) }}"
                                               class="delete_comment">删除评论</a>
                            {% endif %}{% endif %}
                    </div>

                    {% if reply[comment.id] %}
                        <div class="reply_container">
                            {% for reply in reply[comment.id] %}
                                <p class="reply">
                                    回复@{{ comment_author[reply.reply_to] }}:{{ reply.content }}</p>
                                <div class="comment-info">
                                    <input type="hidden" value="{{ reply.author_id }}" class="reply_to">
                                    <input type="hidden" value="{{ reply.id }}" class="parent">
                                    <input type="hidden" value="{{ reply.root_id }}" class="root">
                                    by<span
                                        class="comment-author">{{ comment_author[reply.author_id] }}</span>
                                    <span class="comment-time">at {{ reply.create_time }}</span>
                                    {% if user %}<a href="javascript:" class="pl-hf hf-con-block">回复</a>
                                        {% if user.admin %}
                                            <a href="{{ url_for('admin.delete_comment',comment_id=reply.id) }}"
                                               class="delete_comment">删除评论</a>
                                        {% endif %}{% endif %}
                                    <br><br>
                                </div>
                            {% endfor %}</div>{% endif %}
                    <hr>
                {% endfor %}</div>{% endif %}
        {% if comments %}
            <nav style="text-align: center">
                <ul class="pagination">
                    <li>
                        <a href="

                                {% if pagination.has_prev %}{{ url_for('main.detail',page=pagination.page - 1,article_id = article.id) }}{% else %}#{% endif %}">«</a>
                    </li>
                    {% for p in pagination.iter_pages() %}
                        <li>
                            <a href="{{ url_for('main.detail',page=p,article_id = article.id) }}">{{ p }}</a>
                        </li>
                    {% endfor %}
                    <li>
                        <a href="

                                {% if pagination.has_next %}{{ url_for('main.detail',page=pagination.page + 1,article_id = article.id) }}{% else %}#{% endif %}">»</a>
                    </li>
                </ul>
            </nav>
            </div>{% endif %}
    <!--点击回复动态创建回复块-->
    <script type="text/javascript">
        $('.comment-show').on('click', '.pl-hf', function () {
            //获取回复人的名字
            var fhName = $(this).siblings('.comment-author').html();
            //回复@
            var fhN = '回复@' + fhName + ':';
            var fhHtml = '<div class="hf-con "> <div class="form-group"><textarea class="content comment-input form-control hf-input" placeholder=""></textarea> </div><div class="form-group">\n' +
                '                    <button class="btn btn-default hf-pl" >评论</button>\n</div>';
            //显示回复
            if ($(this).is('.hf-con-block')) {
                $(this).parents('.comment-info').append(fhHtml);
                $(this).removeClass('hf-con-block');
                //input框自动聚焦
                $(this).parents('.comment-info').find('.hf-con').find('.hf-input').val('').focus().val(fhN);
            } else {
                $(this).addClass('hf-con-block');
                $(this).parents('.comment-info').find('.hf-con').remove();
            }
        });
    </script>
    <script>
        $('.comment-show').on('click', '.hf-pl', function () {
            var oHfVal = $(this).parents('.hf-con').find('.hf-input').val();
            var oHfName = $(this).parents('.hf-con').parents('.comment-info').find('.comment-author').html();
            var oAllVal = '回复@' + oHfName + ':';
            if (oHfVal.replace(/^ +| +$/g, '') == '' || oHfVal == oAllVal) {

            } else {
                $.ajax({
                    url: "/add_reply/",
                    type: "POST",
                    data: {
                        content: oHfVal,
                        parent: $(this).parents('.hf-con').siblings('.parent').val(),
                        reply_to: $(this).parents('.hf-con').parents('.comment-info').find('.reply_to').val(),
                        root: $(this).parents('.hf-con').parents('.comment-info').find('.root').val(),
                        article_id: $('#article_id').val()
                    },
                    cache: false,
                    success: function (data) {
                        if (data['status'] == "SUCCESS") {
                            window.location.reload();
                        } else {

                        }
                    }
                });

            }
        });
    </script>

{% endblock %}